<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Papan Markah Matematik - ABMath Galaxy</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
      height: 100vh;
      background: radial-gradient(circle at bottom, #1d4ed8 10%, #3b82f6 40%, #9333ea 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      overflow: hidden;
      position: relative;
      color: white;
    }

    .star { 
      position: absolute; 
      background: white; 
      border-radius: 50%; 
      opacity: 0.7; 
      animation: twinkle 2s infinite ease-in-out alternate; 
    }
    @keyframes twinkle { 
      from { opacity: 0.2; transform: scale(1); } 
      to { opacity: 1; transform: scale(1.5); } 
    }

    img.icon { position: absolute; width: 90px; z-index: 2; }
    .rocket { top: 90px; right: 40px; animation: flyAcross 15s linear infinite; }
    .astronaut { bottom: 180px; right: 80px; animation: float 6s ease-in-out infinite; }
    .meteor { bottom: 200px; left: 60px; animation: float 5s ease-in-out infinite; }
    .comet { top: 60px; left: -100px; animation: flyAcross 14s linear infinite reverse; }

    @keyframes float { 
      0% { transform: translateY(0); } 
      50% { transform: translateY(-15px); } 
      100% { transform: translateY(0); } 
    }
    @keyframes flyAcross { 
      0% { transform: translateX(-200px) rotate(10deg); opacity: 0; } 
      50% { opacity: 1; } 
      100% { transform: translateX(120vw) rotate(25deg); opacity: 0; } 
    }

    .center-image { width: 160px; margin-top: 40px; z-index: 2; }
    h1 { 
      font-size: 2.7em; 
      margin: 10px 0 25px; 
      z-index: 2; 
      text-shadow: 0 0 15px #00f2ff; 
      text-align: center;
    }

    .scoreboard { 
      background: rgba(255, 255, 255, 0.2); 
      border-radius: 20px; 
      padding: 25px; 
      backdrop-filter: blur(10px); 
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3); 
      width: 85%; 
      max-width: 700px; 
      z-index: 3; 
      animation: fadeInUp 1.5s ease; 
    }

    @keyframes fadeInUp { 
      from { transform: translateY(50px); opacity: 0; } 
      to { transform: translateY(0); opacity: 1; } 
    }

    table { 
      width: 100%; 
      border-collapse: collapse; 
      background: rgba(255, 255, 255, 0.85); 
      border-radius: 10px; 
      overflow: hidden; 
    }
    th, td { 
      padding: 12px 15px; 
      text-align: center; 
      border: 1px solid #ccc; 
      font-weight: 500; 
    }
    th { 
      background: #e5e5e5; 
      font-size: 1em; 
      color: #222; 
    }
    td { 
      color: #333; 
      background: rgba(255, 255, 255, 0.8); 
    }

    .settings-btn, .back-btn, .music-btn { 
      position: absolute; 
      top: 20px; 
      background: rgba(255, 255, 255, 0.25); 
      border: none; 
      border-radius: 50%; 
      width: 45px; 
      height: 45px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      cursor: pointer; 
      font-size: 1.3em; 
      color: white; 
      transition: background 0.2s ease; 
      z-index: 10; 
    }
    .settings-btn { right: 70px; }
    .music-btn { right: 20px; }
    .back-btn { left: 20px; z-index: 5; }
    .settings-btn:hover, .music-btn:hover, .back-btn:hover { background: rgba(255, 255, 255, 0.4); }
  </style>
</head>
<body>

  <!-- Buttons -->
  <button class="settings-btn" onclick="window.location.href='settings.html'">&#9881;</button>
  <button class="back-btn" onclick="window.history.back()">&#8592;</button>
  <button class="music-btn" onclick="toggleMusic()">üîä</button>

  <!-- Floating Icons -->
  <img src="rocket.png" alt="rocket" class="icon rocket">
  <img src="astronaut.png" alt="astronaut" class="icon astronaut">
  <img src="meteor.png" alt="meteor" class="icon meteor">
  <img src="comet.png" alt="comet" class="icon comet">

  <!-- Center Planet -->
  <img src="planet.png" alt="planet" class="center-image">
  <h1>Papan Markah <br> Matematik</h1>

  <!-- Scoreboard -->
  <div class="scoreboard">
    <table>
      <thead>
        <tr>
          <th>Rank</th>
          <th>Nama</th>
          <th>Tahap</th>
          <th>Skor Matematik</th>
        </tr>
      </thead>
      <tbody id="leaderboard-body">
        <tr><td colspan="4">Memuatkan data...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Music -->
  <audio id="bg-music" autoplay loop>
    <source src="bgMusic.mp3" type="audio/mpeg">
  </audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

    // üî• Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD3iyKczmk97lG68Pthi_KyPlfY6ZxM9no",
      authDomain: "abmath-galaxy-new.firebaseapp.com",
      projectId: "abmath-galaxy-new",
      storageBucket: "abmath-galaxy-new.appspot.com",
      messagingSenderId: "163126177991",
      appId: "1:163126177991:web:c0562ab5bf7a50c3538ee2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // üßÆ Load Leaderboard from 'users' collection
    async function loadLeaderboard() {
      const tbody = document.getElementById("leaderboard-body");
      tbody.innerHTML = "<tr><td colspan='4'>Memuatkan...</td></tr>";

      try {
        const usersRef = collection(db, "users");
        const q = query(usersRef, orderBy("mathMarks", "desc"), limit(15));
        const snapshot = await getDocs(q);

        tbody.innerHTML = "";

        if (snapshot.empty) {
          tbody.innerHTML = "<tr><td colspan='4'>Tiada data Matematik ditemui.</td></tr>";
          return;
        }

        let rank = 1;
        snapshot.forEach(docSnap => {
          const user = docSnap.data();
          const name = user.name || "Tiada Nama";
          const level = user.highestLevel ?? "-";
          const marks = user.mathMarks ?? 0;

          const row = `
            <tr>
              <td>${rank}</td>
              <td>${name}</td>
              <td>${level}</td>
              <td>${marks}</td>
            </tr>
          `;
          tbody.innerHTML += row;
          rank++;
        });

      } catch (error) {
        console.error("‚ùå Ralat Firestore:", error);
        tbody.innerHTML = "<tr><td colspan='4'>Ralat memuatkan data Matematik.</td></tr>";
      }
    }

    window.addEventListener("load", loadLeaderboard);

    // üéµ Music toggle
    function toggleMusic() {
      const music = document.getElementById("bg-music");
      const btn = document.querySelector(".music-btn");
      if (music.paused) { music.play(); btn.textContent="üîä"; } 
      else { music.pause(); btn.textContent="üîá"; }
    }

    // üåü Stars background
    for (let i = 0; i < 70; i++) {
      const star = document.createElement("div");
      star.classList.add("star");
      star.style.width = star.style.height = (1 + Math.random() * 2) + "px";
      star.style.top = Math.random() * 100 + "vh";
      star.style.left = Math.random() * 100 + "vw";
      star.style.animationDuration = (2 + Math.random() * 3) + "s";
      document.body.appendChild(star);
    }
  </script>

</body>
</html>
