<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AB Math Galaxy - Level 4 Math</title>
<style>
body {
  margin:0; padding:0;
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(to bottom,#1d4ed8,#9333ea);
  display:flex; flex-direction:column; align-items:center;
  min-height:100vh; color:white; position:relative; overflow:hidden;
}

/* Buttons */
.back-btn,.home-btn,.music-btn,.settings-btn{
  position:absolute; top:20px;
  border:none; border-radius:50%;
  width:40px; height:40px;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; font-size:1.2em; color:white;
  background:rgba(255,255,255,0.2); transition:0.2s; z-index:5;
}
.back-btn{left:70px;} .home-btn{left:20px;} .music-btn{right:20px;} .settings-btn{right:70px;}
.back-btn:hover,.home-btn:hover,.music-btn:hover,.settings-btn:hover{background:rgba(255,255,255,0.4);}

/* Floating images */
.floating-img{position:absolute;width:80px;opacity:0.9;z-index:1;}
.rocket{top:100px;left:40px;animation:flyAcross 15s linear infinite;}
.moon{top:150px;right:40px;animation:float 6s ease-in-out infinite;}
.astronaut{bottom:120px;right:60px;animation:float 5s ease-in-out infinite;}
.alien{bottom:50px;left:50px;animation:float 4s ease-in-out infinite;}
.comet{top:30px;right:-100px;animation:flyAcross 12s linear infinite reverse;}

/* Stars */
.star{position:absolute;width:2px;height:2px;background:white;border-radius:50%;opacity:0.8;animation:twinkle 2s infinite ease-in-out alternate; z-index:0;}
@keyframes twinkle{from{opacity:0.3;transform:scale(1);}to{opacity:1;transform:scale(1.5);}}
@keyframes float{0%{transform:translateY(0);}50%{transform:translateY(-15px);}100%{transform:translateY(0);}}
@keyframes flyAcross{0%{transform:translateX(-200px) rotate(10deg);opacity:0;}50%{opacity:1;}100%{transform:translateX(120vw) rotate(25deg);opacity:0;}}
.meteor{position:absolute;top:-100px;width:80px;height:80px;background:url('meteor.png') no-repeat center/contain;opacity:0;pointer-events:none;}
@keyframes diagonalFallRightToLeft{0%{transform:translate(0,0);opacity:1;}100%{transform:translate(-100vw,110vh);opacity:0;}}

/* Top image */
.top-image-wrapper {
  background: rgba(255, 255, 255, 0.1);
  padding: 25px;
  border-radius: 50%;
  margin-top: 40px;
  box-shadow: 0 0 15px rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(6px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2;
  animation: floatUpDown 4s ease-in-out infinite;
}

.top-image {
  width: 130px;
  height: auto;
  animation: softPulse 5s ease-in-out infinite;
}

/* Floating + soft glow animations */
@keyframes floatUpDown {
  0% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
  100% { transform: translateY(0); }
}

@keyframes softPulse {
  0%, 100% { filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.2)); transform: scale(1); }
  50% { filter: drop-shadow(0 0 12px rgba(255, 255, 255, 0.4)); transform: scale(1.03); }
}


/* Question & Dropzones */
h1.question{margin:30px 0 20px;font-size:2em;text-align:center;z-index:2;}
.dropzone-container{display:flex;gap:20px;margin-bottom:30px;z-index:2;}
.dropzone{width:150px;height:60px;border:2px dashed white;border-radius:10px;display:flex;justify-content:center;align-items:center;font-size:1.2em;background:transparent;text-align:center;transition:0.3s;}

/* Choices */
.choices{display:flex;justify-content:center;flex-wrap:wrap;gap:20px;margin-bottom:50px;z-index:2;}
.choice{width:150px;padding:15px;background:linear-gradient(to right,#00f260,#0575e6);border-radius:10px;text-align:center;cursor:grab;user-select:none;box-shadow:0px 0px 20px #00f260;transition:transform 0.2s ease,box-shadow 0.2s ease;z-index:2;}
.choice:hover{transform:scale(1.1);box-shadow:0px 0px 30px #00f260;}

/* Success Message */
#success-message{display:none;margin-top:20px;font-size:1.5em;font-weight:bold;color:#00ffcc;text-align:center;z-index:3;}
</style>
</head>
<body>

<!-- Buttons -->
<button class="settings-btn" onclick="window.location.href='settings.html'">&#9881;</button>
<button class="back-btn" onclick="window.location.href='selectLvlMath.html'">&#8592;</button>
<button class="home-btn" onclick="window.location.href='homepage.html'">üè†</button>
<button class="music-btn" onclick="toggleMusic()">üîä</button>

<!-- Floating images -->
<img src="roket.png" class="floating-img rocket">
<img src="moon.png" class="floating-img moon">
<img src="rocket.png" class="floating-img astronaut">
<img src="planet.png" class="floating-img alien">
<img src="rocket.png" class="floating-img comet">

<!-- Top image -->
<div class="top-image-wrapper"><img src="mathIcon.png" class="top-image"></div>

<!-- Question -->
<h1 class="question">267 + 42 + 51 = </h1>

<!-- Dropzones -->
<div class="dropzone-container">
  <div class="dropzone" id="dropzone1">Letak nombor pertama</div>
  <div class="dropzone" id="dropzone2">Letak nombor kedua</div>
  <div class="dropzone" id="dropzone3">Letak nombor ketiga</div>
</div>

<!-- Choices -->
<div class="choices">
  <div class="choice" draggable="true" id="choice1">1</div>
  <div class="choice" draggable="true" id="choice2">6</div>
  <div class="choice" draggable="true" id="choice3">2</div>
  <div class="choice" draggable="true" id="choice4">3</div>
  <div class="choice" draggable="true" id="choice5">0</div>
</div>

<!-- Success message -->
<div id="success-message">‚úÖ Semua jawapan betul! <span id="points-display"></span></div>

<!-- Audio -->
<audio id="bg-music" autoplay loop><source src="bgMusic.mp3" type="audio/mpeg"></audio>
<audio id="meteor-sound" src="whoosh.mp3"></audio>
<div class="meteor"></div><div class="meteor"></div><div class="meteor"></div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
import { getFirestore, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyD3iyKczmk97lG68Pthi_KyPlfY6ZxM9no",
  authDomain: "abmath-galaxy-new.firebaseapp.com",
  projectId: "abmath-galaxy-new",
  storageBucket: "abmath-galaxy-new.appspot.com",
  messagingSenderId: "163126177991",
  appId: "1:163126177991:web:c0562ab5bf7a50c3538ee2"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Track question start time
const questionStartTime = Date.now();

// Dropzones & correct answers
const dropzones = {
  dropzone1: { element: document.getElementById('dropzone1'), correct: "3", filled: false },
  dropzone2: { element: document.getElementById('dropzone2'), correct: "6", filled: false },
  dropzone3: { element: document.getElementById('dropzone3'), correct: "0", filled: false }
};

const choices = document.querySelectorAll('.choice');
const successMsg = document.getElementById('success-message');

choices.forEach(choice=>{
  choice.addEventListener('dragstart', e=>{
    e.dataTransfer.setData('text', choice.textContent.trim());
  });
});

// Dropzone events
Object.keys(dropzones).forEach(key=>{
  const dz = dropzones[key].element;
  dz.addEventListener('dragover', e=>e.preventDefault());
  dz.addEventListener('drop', async e=>{
    e.preventDefault();
    if(dropzones[key].filled) return;

    const text = e.dataTransfer.getData('text');
    if(text === dropzones[key].correct){
      dz.style.background="green";
      dz.textContent=`Betul: ${text}`;
      dropzones[key].filled=true;

      if(Object.values(dropzones).every(dz=>dz.filled)){
        // Time-based scoring
        const elapsed = (Date.now()-questionStartTime)/1000;
        let points=0;
        if(elapsed<=2) points=15;
        else if(elapsed<=5) points=10;
        else if(elapsed<=10) points=5;
        else points=2;

        successMsg.style.display="block";
        document.getElementById('points-display').textContent = `(+${points} markah)`;

        // Save to Firestore
        onAuthStateChanged(auth, async user=>{
          if(user){
            const userRef = doc(db,"users",user.uid);
            await updateDoc(userRef,{
               mathMarks: increment(points),
              highestMathLevel: Math.max(4, (user.highestMathLevel||0))
            });
          }
        });

        // Countdown to next question
        let countdown=3;
        const interval = setInterval(()=>{
          if(countdown>0){
            successMsg.textContent=`‚úÖ Semua jawapan betul! (+${points} markah) Soalan seterusnya dalam ${countdown}`;
            countdown--;
          }else{
            clearInterval(interval);
            goToNextQuestion();
          }
        },1000);
      }
    }else{
      dz.style.background="red";
      dz.textContent=`Salah: ${text}`;
      setTimeout(()=>{ dz.style.background=""; dz.textContent=`Letak nombor ${key.slice(-1)}`; },1000);
    }
  });
});

// ======== Music toggle & persistence across all pages ========
function toggleMusic() {
  const music = document.getElementById('bg-music');
  const btn = document.querySelector('.music-btn');
  
  if (music.paused) {
    music.play();
    btn.textContent = 'üîä';
    localStorage.setItem('musicState', 'playing');
  } else {
    music.pause();
    btn.textContent = 'üîá';
    localStorage.setItem('musicState', 'muted');
  }
}

// When leaving the page, save the time
window.addEventListener('beforeunload', () => {
  const music = document.getElementById('bg-music');
  localStorage.setItem('bgMusicTime', music.currentTime);
});

// When page loads, restore the state
window.addEventListener('load', () => {
  const music = document.getElementById('bg-music');
  const btn = document.querySelector('.music-btn');
  const savedTime = localStorage.getItem('bgMusicTime');
  const musicState = localStorage.getItem('musicState');

  if (savedTime) music.currentTime = parseFloat(savedTime);

  if (musicState === 'muted') {
    music.pause();
    btn.textContent = 'üîá';
  } else {
    music.play();
    btn.textContent = 'üîä';
  }
});

// Meteors
const meteors=document.querySelectorAll('.meteor');
const meteorSound=document.getElementById('meteor-sound');
function launchMeteor(m){
  const delay=Math.random()*4000+2000;
  const startX=Math.random()*window.innerWidth;
  const startY=Math.random()*-200;
  m.style.left=`${startX}px`; m.style.top=`${startY}px`;
  setTimeout(()=>{
    m.style.animation=`diagonalFallRightToLeft 3s linear`;
    meteorSound.currentTime=0; meteorSound.play();
    setTimeout(()=>{ m.style.animation=''; launchMeteor(m); },3000);
  },delay);
}
meteors.forEach(m=>launchMeteor(m));

// Next question logic
function goToNextQuestion(){
  const currentPath=window.location.pathname.split('/').pop();
  const level=currentPath.match(/lvl(\d+)Math/i);
  if(!level)return;
  const levelNumber=parseInt(level[1]);
  let questions=JSON.parse(localStorage.getItem(`mathLevel${levelNumber}Questions`))||[];
  let usedQuestions=JSON.parse(localStorage.getItem(`usedMathLevel${levelNumber}`))||[];
  if(!usedQuestions.includes(currentPath)) usedQuestions.push(currentPath);
  localStorage.setItem(`usedMathLevel${levelNumber}`,JSON.stringify(usedQuestions));

  const nextQ=questions.find(q=>!usedQuestions.includes(q));
  if(nextQ) window.location.href=nextQ;
  else{
    alert("Tahniah! Semua soalan selesai!");
    let highestUnlocked=parseInt(localStorage.getItem('highestUnlockedMath')||'1');
    if(levelNumber===highestUnlocked && highestUnlocked<5) localStorage.setItem('highestUnlockedMath',highestUnlocked+1);
    window.location.href="selectLvlMath.html";
  }
}
// ======== Stars ========
    for (let i = 0; i < 80; i++) {
      const star = document.createElement('div');
      star.classList.add('star');
      star.style.top = Math.random() * 100 + 'vh';
      star.style.left = Math.random() * 100 + 'vw';
      star.style.animationDuration = 1 + Math.random() * 2 + 's';
      star.style.width = star.style.height = (1 + Math.random() * 2) + 'px';
      document.body.appendChild(star);
    }
</script>
</body>
</html>
