<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Profile - ABMath Galaxy</title>
<style>
    body {
        margin: 0;
        padding: 0;
        font-family: 'Poppins', sans-serif;
        height: 100vh;
        background: linear-gradient(to right, #1d4ed8, #9333ea);
        display: flex;
        flex-direction: column;
        align-items: center;
        color: white;
        position: relative;
    }

    .back-btn {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.2em;
        color: white;
        transition: background 0.2s ease;
        z-index: 5;
    }
    .back-btn:hover { background: rgba(255, 255, 255, 0.4); }

    .music-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.2em;
        color: white;
        transition: background 0.2s ease;
        z-index: 5;
    }
    .music-btn:hover { background: rgba(255, 255, 255, 0.4); }

    .profile-container {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 20px;
        margin-top: 80px;
        width: 80%;
        max-width: 350px;
        text-align: center;
    }

    .profile-container h2 {
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 15px;
        text-align: left;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }

    .form-group input {
        width: 100%;
        padding: 10px;
        border-radius: 10px;
        border: none;
        outline: none;
    }

    .save-btn {
        background: linear-gradient(to right, #00f260, #0575e6);
        border: none;
        border-radius: 25px;
        padding: 12px;
        width: 100%;
        margin-top: 15px;
        font-size: 1em;
        font-weight: bold;
        color: white;
        cursor: pointer;
        transition: transform 0.2s ease;
    }
    .save-btn:hover { transform: scale(1.05); }

    .message {
        margin-top: 15px;
        font-size: 0.9em;
        color: #aaffaa;
        display: none;
    }
</style>
</head>
<body>

<!-- Back & Music Buttons -->
<button class="back-btn" onclick="window.location.href='settings.html'">&#8592;</button>
<button class="music-btn" onclick="toggleMusic()">🔊</button>

<!-- Background Music -->
<audio id="bg-music" autoplay loop>
    <source src="bgMusic.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
</audio>

<div class="profile-container">
    <h2>Edit Profile</h2>
    <form id="editProfileForm">
        <div class="form-group">
            <label for="username">Name</label>
            <input type="text" id="username" name="username" placeholder="Enter your name" required>
        </div>
        <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" placeholder="Enter your email" required>
        </div>
        <div class="form-group">
            <label for="password">New Password</label>
            <input type="password" id="password" name="password" placeholder="Enter new password">
        </div>
        <button type="submit" class="save-btn">Save Changes</button>
    </form>
    <div class="message" id="successMessage">Profile updated successfully!</div>
</div>

<script>
/* 🎵 Music Control System */
// ======== Music toggle & persistence across all pages ========
function toggleMusic() {
  const music = document.getElementById('bg-music');
  const btn = document.querySelector('.music-btn');
  
  if (music.paused) {
    music.play();
    btn.textContent = '🔊';
    localStorage.setItem('musicState', 'playing');
  } else {
    music.pause();
    btn.textContent = '🔇';
    localStorage.setItem('musicState', 'muted');
  }
}

// When leaving the page, save the time
window.addEventListener('beforeunload', () => {
  const music = document.getElementById('bg-music');
  localStorage.setItem('bgMusicTime', music.currentTime);
});

// When page loads, restore the state
window.addEventListener('load', () => {
  const music = document.getElementById('bg-music');
  const btn = document.querySelector('.music-btn');
  const savedTime = localStorage.getItem('bgMusicTime');
  const musicState = localStorage.getItem('musicState');

  if (savedTime) music.currentTime = parseFloat(savedTime);

  if (musicState === 'muted') {
    music.pause();
    btn.textContent = '🔇';
  } else {
    music.play();
    btn.textContent = '🔊';
  }
});
</script>

<!-- 🔥 Firebase Edit Profile Integration -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, onAuthStateChanged, updateEmail, updatePassword } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD3iyKczmk97lG68Pthi_KyPlfY6ZxM9no",
  authDomain: "abmath-galaxy-new.firebaseapp.com",
  projectId: "abmath-galaxy-new",
  storageBucket: "abmath-galaxy-new.appspot.com",
  messagingSenderId: "163126177991",
  appId: "1:163126177991:web:c0562ab5bf7a50c3538ee2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let userRole = null;

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  currentUser = user;

  const userRef = doc(db, "users", user.uid);
  const userSnap = await getDoc(userRef);

  if (userSnap.exists()) {
    const data = userSnap.data();
    document.getElementById("username").value = data.name || "";
    document.getElementById("email").value = user.email || "";
    userRole = data.role; // store the user's role
  }
});

document.getElementById("editProfileForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const name = document.getElementById("username").value.trim();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();

  if (!name || !email) return alert("Please fill in all required fields.");

  try {
    const userRef = doc(db, "users", currentUser.uid);
    await updateDoc(userRef, { name });

    if (email !== currentUser.email) await updateEmail(currentUser, email);
    if (password) await updatePassword(currentUser, password);

    document.getElementById("successMessage").style.display = "block";

    // 🔁 Auto redirect to dashboard after 2 seconds
    setTimeout(() => {
      if (userRole === "student") {
        window.location.href = "studentDashboard.html";
      } else if (userRole === "teacher") {
        window.location.href = "teacherDashboard.html";
      } else if (userRole === "parent") {
        window.location.href = "parentDashboard.html";
      } else {
        window.location.href = "settings.html";
      }
    }, 2000);
  } catch (error) {
    console.error(error);
    alert("Failed to update profile. Please re-login and try again.");
  }
});
</script>

</body>
</html>
