<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AB Math Galaxy - Level 4 BM</title>
<style>
body {
  margin: 0;
  padding: 0;
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(to bottom, #1d4ed8, #9333ea);
  color: white;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  position: relative;
  overflow: hidden;
}

/* Buttons */
.back-btn, .home-btn, .music-btn, .settings-btn {
  position: absolute; top: 20px;
  border: none; border-radius: 50%;
  width: 40px; height: 40px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 1.2em; color: white;
  background: rgba(255,255,255,0.2); transition: background 0.2s ease; z-index: 5;
}
.back-btn { left: 70px; }
.home-btn { left: 20px; }
.music-btn { right: 20px; }
.settings-btn { right: 70px; }
.back-btn:hover, .home-btn:hover, .music-btn:hover, .settings-btn:hover { background: rgba(255,255,255,0.4); }

/* Floating images */
.floating-img { position: absolute; width: 80px; opacity: 0.9; z-index:1; }
.rocket { top:100px; left:40px; }
.moon { top:150px; right:40px; }
.meteor { bottom:100px; left:60px; }
.astronaut { bottom:120px; right:60px; }

h1 { margin-top:80px; font-size:1.8em; text-align:center; z-index:2; }
.image-container {
  background: rgba(255,255,255,0.1);
  padding: 15px;             /* smaller padding */
  border-radius: 20px;
  margin-top: 30px;          /* moved up from 50px to 30px */
  box-shadow: 0 0 15px rgba(255,255,255,0.2);
  backdrop-filter: blur(6px);
  z-index: 2;
  animation: popIn 0.8s ease;
  display: flex;
  justify-content: center;
  align-items: center;
}

.image-container img {
  width: 110px;              /* slightly smaller from 130px */
  height: auto;
  animation: float 4s ease-in-out infinite;
}


/* Dropzones */
.dropzones { display:flex; gap:20px; margin-top:25px; z-index:2; }
.dropzone {
  width:150px; height:60px; border:2px dashed white; border-radius:10px;
  display:flex; align-items:center; justify-content:center; font-size:1.1em;
  text-align:center; transition: background 0.3s ease;
}

/* Choices */
.choices { display:flex; justify-content:center; flex-wrap:wrap; gap:20px; margin-top:25px; z-index:2; }
.choice {
  width:120px; padding:15px; background: linear-gradient(to right,#f9d423,#ff4e50);
  border-radius:10px; text-align:center; cursor:grab; user-select:none; font-size:1.2em; font-weight:bold; color:black;
  box-shadow:0px 0px 15px rgba(255,255,255,0.5); transition: transform 0.2s ease, box-shadow 0.2s ease; z-index:2;
}
.choice:hover { transform:scale(1.1); box-shadow:0px 0px 25px rgba(255,255,255,0.7); }

/* Message */
#message { margin-top:20px; font-size:1.5em; font-weight:bold; color:#00ffcc; text-align:center; display:none; z-index:3; }

/* Meteor animation */
.meteor { position:absolute; top:-100px; width:80px; height:80px; background:url('meteor.png') no-repeat center/contain; opacity:0; pointer-events:none; }
@keyframes diagonalFallRightToLeft {
  0% { transform:translate(0,0); opacity:1; }
  100% { transform:translate(-100vw,110vh); opacity:0; }
}
/* Floating Decorations */
    .floating-img {
      position: absolute;
      width: 80px;
      opacity: 0.9;
      z-index: 1;
    }
    .rocket { top: 100px; left: 40px; animation: flyAcross 15s linear infinite; }
    .moon { top: 150px; right: 40px; animation: float 6s ease-in-out infinite; }
    .astronaut { bottom: 120px; right: 60px; animation: float 5s ease-in-out infinite; }
    .alien { bottom: 50px; left: 50px; animation: float 4s ease-in-out infinite; }
    .comet { top: 30px; right: -100px; animation: flyAcross 12s linear infinite reverse; }

    /* Stars */
    .star {
      position: absolute;
      width: 2px;
      height: 2px;
      background: white;
      border-radius: 50%;
      opacity: 0.8;
      animation: twinkle 2s infinite ease-in-out alternate;
      z-index: 0;
    }
    @keyframes twinkle {
      from { opacity: 0.3; transform: scale(1); }
      to { opacity: 1; transform: scale(1.5); }
    }

    /* Floating Animations */
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-15px); }
      100% { transform: translateY(0px); }
    }

    @keyframes flyAcross {
      0% { transform: translateX(-200px) rotate(10deg); opacity: 0; }
      50% { opacity: 1; }
      100% { transform: translateX(120vw) rotate(25deg); opacity: 0; }
    }
</style>
</head>

<body>
<!-- Buttons -->
<button class="settings-btn" onclick="window.location.href='settings.html'">&#9881;</button>
<button class="back-btn" onclick="window.location.href='selectLvl.html'">&#8592;</button>
<button class="home-btn" onclick="window.location.href='homepage.html'" title="Home">üè†</button>
<button class="music-btn" onclick="toggleMusic()" title="Toggle Music">üîä</button>

<!-- Floating Images -->
<img src="roket.png" alt="rocket" class="floating-img rocket">
  <img src="moon.png" alt="moon" class="floating-img moon">
  <img src="rocket.png" alt="astronaut" class="floating-img astronaut">
  <img src="planet.png" alt="alien" class="floating-img alien">
  <img src="rocket.png" alt="comet" class="floating-img comet">

<!-- Question -->
<h1>Susun Perkataan Yang Betul Bagi Gambar</h1>
<h3>Apa yang berlaku pada pensil itu?</h3>
<div class="image-container">
  <img src="pensil.png" alt="Pelangi">
</div>

<!-- Dropzones -->
<div class="dropzones">
  <div class="dropzone" id="dropzone1">Letakkan jawapan 1</div>
  <div class="dropzone" id="dropzone2">Letakkan jawapan 2</div>
  <div class="dropzone" id="dropzone3">Letakkan jawapan 3</div>
</div>

<!-- Choices -->
<div class="choices">
  <div class="choice" draggable="true" data-answer="1">Pensil</div>
    <div class="choice" draggable="true" data-answer="2">Lari</div>
    <div class="choice" draggable="true" data-answer="3">Itu</div>
    <div class="choice" draggable="true" data-answer="4">Ali</div>
    <div class="choice" draggable="true" data-answer="5">Patah</div>
    <div class="choice" draggable="true" data-answer="6">Bulatan</div>
</div>

<!-- Message -->
<div id="message"></div>

<!-- Background Music -->
<audio id="bg-music" autoplay loop>
  <source src="bgMusic.mp3" type="audio/mpeg">
</audio>
<audio id="meteor-sound" src="whoosh.mp3"></audio>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
import { getFirestore, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyD3iyKczmk97lG68Pthi_KyPlfY6ZxM9no",
  authDomain: "abmath-galaxy-new.firebaseapp.com",
  projectId: "abmath-galaxy-new",
  storageBucket: "abmath-galaxy-new.appspot.com",
  messagingSenderId: "163126177991",
  appId: "1:163126177991:web:c0562ab5bf7a50c3538ee2"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Track question start time
const questionStartTime = Date.now();

// Correct answers
const dropzones = {
  dropzone1: { element: document.getElementById('dropzone1'), correct: "Pensil", filled:false },
  dropzone2: { element: document.getElementById('dropzone2'), correct: "Itu", filled:false },
  dropzone3: { element: document.getElementById('dropzone3'), correct: "Patah", filled:false }
};

const choices = document.querySelectorAll('.choice');
const message = document.getElementById('message');

choices.forEach(choice=>{
  choice.addEventListener('dragstart', e=>{
    e.dataTransfer.setData('text', choice.textContent);
  });
});

Object.keys(dropzones).forEach(key=>{
  const dz = dropzones[key].element;
  dz.addEventListener('dragover', e=>e.preventDefault());
  dz.addEventListener('drop', async e=>{
    e.preventDefault();
    if(dropzones[key].filled) return;
    const text = e.dataTransfer.getData('text');

    if(text === dropzones[key].correct){
      dz.style.background="green";
      dz.textContent=`Betul: ${text}`;
      dropzones[key].filled = true;

      if(Object.values(dropzones).every(dz=>dz.filled)){
        // Calculate points based on time
        const elapsed = (Date.now() - questionStartTime)/1000;
        let points = 0;
        if(elapsed<=2) points=15;
        else if(elapsed<=5) points=10;
        else if(elapsed<=10) points=5;
        else points=2;

        message.style.display="block";
        message.textContent=`‚úÖ Semua jawapan betul! (+${points} markah)`;

        // Award points to Firestore
        onAuthStateChanged(auth, async user=>{
          if(user){
            const userRef = doc(db,"users",user.uid);
            await updateDoc(userRef, { totalMarks: increment(points), highestLevel: Math.max(4, (user.highestLevel||0)) });
          }
        });

        // Countdown 3s then next
        let countdown=3;
        const interval = setInterval(()=>{
          if(countdown>0){
            message.textContent=`‚úÖ Semua jawapan betul! (+${points} markah) Soalan seterusnya dalam ${countdown}`;
            countdown--;
          }else{
            clearInterval(interval);
            goToNextQuestion();
          }
        },1000);
      }
    }else{
      dz.style.background="red";
      dz.textContent=`Salah: ${text}`;
      setTimeout(()=>{ dz.style.background=""; dz.textContent=`Letakkan jawapan ${key.slice(-1)}`; },1000);
    }
  });
});

// ======== Music toggle & persistence across all pages ========
function toggleMusic() {
  const music = document.getElementById('bg-music');
  const btn = document.querySelector('.music-btn');
  
  if (music.paused) {
    music.play();
    btn.textContent = 'üîä';
    localStorage.setItem('musicState', 'playing');
  } else {
    music.pause();
    btn.textContent = 'üîá';
    localStorage.setItem('musicState', 'muted');
  }
}

// When leaving the page, save the time
window.addEventListener('beforeunload', () => {
  const music = document.getElementById('bg-music');
  localStorage.setItem('bgMusicTime', music.currentTime);
});

// When page loads, restore the state
window.addEventListener('load', () => {
  const music = document.getElementById('bg-music');
  const btn = document.querySelector('.music-btn');
  const savedTime = localStorage.getItem('bgMusicTime');
  const musicState = localStorage.getItem('musicState');

  if (savedTime) music.currentTime = parseFloat(savedTime);

  if (musicState === 'muted') {
    music.pause();
    btn.textContent = 'üîá';
  } else {
    music.play();
    btn.textContent = 'üîä';
  }
});


// Next question navigation (from selectLvlBm)
function goToNextQuestion(){
  const currentPath = window.location.pathname.split('/').pop();
  const level = currentPath.match(/lvl(\d+)Bm/i);
  if(!level) return;
  const levelNumber = parseInt(level[1]);
  let questions = JSON.parse(localStorage.getItem(`bmLevel${levelNumber}Questions`))||[];
  let usedQuestions = JSON.parse(localStorage.getItem(`usedBmLevel${levelNumber}`))||[];

  if(!usedQuestions.includes(currentPath)) usedQuestions.push(currentPath);
  localStorage.setItem(`usedBmLevel${levelNumber}`, JSON.stringify(usedQuestions));

  const nextQ = questions.find(q=>!usedQuestions.includes(q));
  if(nextQ) window.location.href = nextQ;
  else {
    alert("Tahniah! Anda telah menamatkan semua soalan di Tahap ini!");
    // Unlock next level sequentially
    let highestUnlocked = parseInt(localStorage.getItem('highestUnlocked')||'1');
    if(levelNumber === highestUnlocked && highestUnlocked<5) localStorage.setItem('highestUnlocked', highestUnlocked+1);
    window.location.href="selectLvl.html";
  }
}

// Meteors
const meteors = document.querySelectorAll('.meteor');
const meteorSound = document.getElementById('meteor-sound');
function launchMeteor(m){
  const delay=Math.random()*4000+2000;
  const startX=Math.random()*window.innerWidth;
  const startY=Math.random()*-200;
  m.style.left=`${startX}px`; m.style.top=`${startY}px`;
  setTimeout(()=>{
    m.style.animation=`diagonalFallRightToLeft 3s linear`;
    meteorSound.currentTime=0; meteorSound.play();
    setTimeout(()=>{ m.style.animation=''; launchMeteor(m); },3000);
  },delay);
}
meteors.forEach(m=>launchMeteor(m));

const music = document.getElementById('bg-music');

// Save current time before leaving
window.addEventListener('beforeunload', () => {
  localStorage.setItem('musicTime', music.currentTime);
});

// Resume music when page loads
window.addEventListener('DOMContentLoaded', () => {
  const lastTime = localStorage.getItem('musicTime');
  if (lastTime) {
    music.currentTime = parseFloat(lastTime);
  }
  music.play();
});
// --- Stars ---
for(let i=0;i<60;i++){
  const star=document.createElement('div');
  star.classList.add('star');
  star.style.top=Math.random()*100+'vh';
  star.style.left=Math.random()*100+'vw';
  star.style.animationDuration=(2+Math.random()*2)+'s';
  document.body.appendChild(star);
}
</script>
</body>
</html>
